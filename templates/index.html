<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Command The Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans flex flex-col items-center min-h-screen p-4">

  <div class="w-full max-w-xl bg-white shadow-xl rounded-2xl overflow-hidden flex flex-col h-[90vh]">
    <header class="bg-indigo-600 text-white text-center p-4 text-xl font-semibold">
      Command DG Chatbot
      <div class="mt-3">
      <select id="agent" class="px-4 py-2 border rounded-lg text-black">
      <option value="friendly">Friendly Chat</option>
      <option value="deep">Deep Thinking</option>
      <option value="research">Research</option>
      </select>
      </div>
    </header>

    <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4">
      <!-- Chat messages will appear here -->
    </div>

    <form id="chat-form" class="flex border-t p-4" onsubmit="sendMessage(event)">
      <input id="prompt" type="text" class="flex-1 px-4 py-2 border rounded-l-lg outline-none focus:ring focus:ring-indigo-300" placeholder="Type your message..." required />
      <button type="submit" class="bg-indigo-600 text-white px-5 rounded-r-lg hover:bg-indigo-700">Send</button>
      <button id="mic-btn" type="button" class="ml-2 bg-gray-300 px-4 rounded hover:bg-gray-400">ğŸ™ï¸</button>
      <button id="mute-btn" type="button" class="ml-2 px-4 rounded">ğŸ”‡ Mute</button>
    </form>
  </div>

  <script>
    const input = document.getElementById('prompt');
    const chatWindow = document.getElementById('chat-window');
    const micBtn = document.getElementById('mic-btn');
    const muteBtn = document.getElementById('mute-btn');
    const agentSelector = document.getElementById('agent');

    let isMuted = localStorage.getItem('isMuted') === 'true';

    // Apply initial mute button state
    updateMuteButton();

    muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      localStorage.setItem('isMuted', isMuted);
      updateMuteButton();

      // Stop any ongoing speech immediately
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
    });

    function updateMuteButton() {
      muteBtn.textContent = isMuted ? 'ğŸ”ˆ Unmute' : 'ğŸ”‡ Mute';
      muteBtn.classList.toggle('bg-red-300', !isMuted);
      muteBtn.classList.toggle('bg-green-300', isMuted);
    }

    async function sendMessage(event) {
      event.preventDefault();
      const userMessage = input.value.trim();
      const mode = agentSelector.value;

      if (!userMessage) return;

      // Display user message
      chatWindow.innerHTML += `
        <div class="text-right">
          <div class="inline-block bg-indigo-100 text-indigo-800 p-3 rounded-xl max-w-xs">${userMessage}</div>
        </div>
      `;
      input.value = '';
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Send to backend
      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: userMessage, mode })
      });

      const data = await res.json();
      const botReply = data.response || data.error;

      // Format long replies into bullets
      const formattedReply = formatReply(botReply);

      // Display bot response
      chatWindow.innerHTML += `
        <div class="text-left">
          <div class="inline-block bg-gray-200 text-gray-800 p-3 rounded-xl max-w-xs">${formattedReply}</div>
        </div>
      `;
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Speak response
      speak(botReply);
    }

    // Format long replies into bullet points
    function formatReply(text) {
      const lines = text.split(/\n|(?<=\.)\s+/).filter(line => line.trim().length > 0);
      if (lines.length <= 2) return text;

      return '<ul class="list-disc pl-5 space-y-1">' +
        lines.map(line => `<li>${line.trim()}</li>`).join('') +
        '</ul>';
    }

    // Voice input
    micBtn.addEventListener('click', () => {
      if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        micBtn.disabled = true;
        micBtn.title = "Voice input not supported";
        return;
      }

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        input.focus();
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
      };
    });

    // Voice output
    function speak(text) {
      if (isMuted) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>